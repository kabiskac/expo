{"version":3,"file":"ExpoLocation.web.js","sourceRoot":"","sources":["../src/ExpoLocation.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { PermissionResponse, PermissionStatus } from 'expo-modules-core';\r\n\r\nimport {\r\n  LocationLastKnownOptions,\r\n  LocationObject,\r\n  LocationOptions,\r\n  LocationAccuracy,\r\n} from './Location.types';\r\nimport { LocationEventEmitter } from './LocationEventEmitter';\r\n\r\nclass GeocoderError extends Error {\r\n  code: string;\r\n\r\n  constructor() {\r\n    super('Geocoder service is not available for this device.');\r\n    this.code = 'E_NO_GEOCODER';\r\n  }\r\n}\r\n\r\n/**\r\n * Converts `GeolocationPosition` to JavaScript object.\r\n */\r\nfunction geolocationPositionToJSON(position: LocationObject): LocationObject {\r\n  const { coords, timestamp } = position;\r\n  return {\r\n    coords: {\r\n      latitude: coords.latitude,\r\n      longitude: coords.longitude,\r\n      altitude: coords.altitude,\r\n      accuracy: coords.accuracy,\r\n      altitudeAccuracy: coords.altitudeAccuracy,\r\n      heading: coords.heading,\r\n      speed: coords.speed,\r\n    },\r\n    timestamp,\r\n  };\r\n}\r\n\r\n/**\r\n * Checks whether given location didn't exceed given `maxAge` and fits in the required accuracy.\r\n */\r\nfunction isLocationValid(location: LocationObject, options: LocationLastKnownOptions): boolean {\r\n  const maxAge = typeof options.maxAge === 'number' ? options.maxAge : Infinity;\r\n  const requiredAccuracy =\r\n    typeof options.requiredAccuracy === 'number' ? options.requiredAccuracy : Infinity;\r\n  const locationAccuracy = location.coords.accuracy ?? Infinity;\r\n\r\n  return Date.now() - location.timestamp <= maxAge && locationAccuracy <= requiredAccuracy;\r\n}\r\n\r\n/**\r\n * Gets the permission details. The implementation is not very good as it actually requests\r\n * for the current location, but there is no better way on web so far :(\r\n */\r\nasync function getPermissionsAsync(): Promise<PermissionResponse> {\r\n  return new Promise<PermissionResponse>((resolve) => {\r\n    const resolveWithStatus = (status) =>\r\n      resolve({\r\n        status,\r\n        granted: status === PermissionStatus.GRANTED,\r\n        canAskAgain: true,\r\n        expires: 0,\r\n      });\r\n\r\n    navigator.geolocation.getCurrentPosition(\r\n      () => resolveWithStatus(PermissionStatus.GRANTED),\r\n      ({ code }) => {\r\n        if (code === 1 /* PERMISSION_DENIED */) {\r\n          resolveWithStatus(PermissionStatus.DENIED);\r\n        } else {\r\n          resolveWithStatus(PermissionStatus.UNDETERMINED);\r\n        }\r\n      },\r\n      { enableHighAccuracy: false, maximumAge: Infinity }\r\n    );\r\n  });\r\n}\r\n\r\nlet lastKnownPosition: LocationObject | null = null;\r\n\r\nexport default {\r\n  get name(): string {\r\n    return 'ExpoLocation';\r\n  },\r\n  async getProviderStatusAsync(): Promise<{ locationServicesEnabled: boolean }> {\r\n    return {\r\n      locationServicesEnabled: 'geolocation' in navigator,\r\n    };\r\n  },\r\n  async getLastKnownPositionAsync(\r\n    options: LocationLastKnownOptions = {}\r\n  ): Promise<LocationObject | null> {\r\n    if (lastKnownPosition && isLocationValid(lastKnownPosition, options)) {\r\n      return lastKnownPosition;\r\n    }\r\n    return null;\r\n  },\r\n  async getCurrentPositionAsync(options: LocationOptions): Promise<LocationObject> {\r\n    return new Promise<LocationObject>((resolve, reject) => {\r\n      const resolver = (position) => {\r\n        lastKnownPosition = geolocationPositionToJSON(position);\r\n        resolve(lastKnownPosition);\r\n      };\r\n      navigator.geolocation.getCurrentPosition(resolver, reject, {\r\n        maximumAge: Infinity,\r\n        enableHighAccuracy: (options.accuracy ?? 0) > LocationAccuracy.Balanced,\r\n        ...options,\r\n      });\r\n    });\r\n  },\r\n  async removeWatchAsync(watchId): Promise<void> {\r\n    navigator.geolocation.clearWatch(watchId);\r\n  },\r\n  async watchDeviceHeading(headingId): Promise<void> {\r\n    console.warn('Location.watchDeviceHeading: is not supported on web');\r\n  },\r\n  async hasServicesEnabledAsync(): Promise<boolean> {\r\n    return 'geolocation' in navigator;\r\n  },\r\n  async geocodeAsync(): Promise<any[]> {\r\n    throw new GeocoderError();\r\n  },\r\n  async reverseGeocodeAsync(): Promise<any[]> {\r\n    throw new GeocoderError();\r\n  },\r\n  async watchPositionImplAsync(watchId: string, options: LocationOptions): Promise<string> {\r\n    return new Promise<string>((resolve) => {\r\n      // @ts-ignore: the types here need to be fixed\r\n      watchId = global.navigator.geolocation.watchPosition(\r\n        (position) => {\r\n          lastKnownPosition = geolocationPositionToJSON(position);\r\n          LocationEventEmitter.emit('Expo.locationChanged', {\r\n            watchId,\r\n            location: lastKnownPosition,\r\n          });\r\n        },\r\n        undefined,\r\n        // @ts-ignore: the options object needs to be fixed\r\n        options\r\n      );\r\n      resolve(watchId);\r\n    });\r\n  },\r\n\r\n  getPermissionsAsync,\r\n  async requestPermissionsAsync(): Promise<PermissionResponse> {\r\n    return getPermissionsAsync();\r\n  },\r\n  async requestForegroundPermissionsAsync(): Promise<PermissionResponse> {\r\n    return getPermissionsAsync();\r\n  },\r\n  async requestBackgroundPermissionsAsync(): Promise<PermissionResponse> {\r\n    return getPermissionsAsync();\r\n  },\r\n  async getForegroundPermissionsAsync(): Promise<PermissionResponse> {\r\n    return getPermissionsAsync();\r\n  },\r\n  async getBackgroundPermissionsAsync(): Promise<PermissionResponse> {\r\n    return getPermissionsAsync();\r\n  },\r\n\r\n  // no-op\r\n  startObserving() {},\r\n  stopObserving() {},\r\n};\r\n"]}
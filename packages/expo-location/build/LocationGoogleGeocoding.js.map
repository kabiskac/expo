{"version":3,"file":"LocationGoogleGeocoding.js","sourceRoot":"","sources":["../src/LocationGoogleGeocoding.ts"],"names":[],"mappings":"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","sourcesContent":["import { CodedError } from 'expo-modules-core';\r\n\r\nimport { LocationGeocodedAddress, LocationGeocodedLocation } from './Location.types';\r\n\r\nconst GOOGLE_API_URL = 'https://maps.googleapis.com/maps/api/geocode/json';\r\nlet googleApiKey;\r\n\r\ntype GoogleApiGeocodingAddressComponent = {\r\n  long_name: string;\r\n  short_name: string;\r\n  types: string[];\r\n};\r\n\r\ntype GoogleApiGeocodingResult = {\r\n  address_components: GoogleApiGeocodingAddressComponent[];\r\n  formatted_address: string;\r\n  geometry: {\r\n    location: {\r\n      lat: number;\r\n      lng: number;\r\n    };\r\n  };\r\n};\r\n\r\ntype GoogleApiGeocodingResponse = {\r\n  results: GoogleApiGeocodingResult[];\r\n  status: string;\r\n};\r\n\r\n// @needsAudit\r\n/**\r\n * Sets a Google API Key for using Google Maps Geocoding API which is used by default on Web\r\n * platform and can be enabled through `useGoogleMaps` option of `geocodeAsync` and `reverseGeocodeAsync`\r\n * methods. It might be useful for Android devices that do not have Google Play Services, hence no\r\n * Geocoder Service.\r\n * @param apiKey Google API key obtained from Google API Console. This API key must have `Geocoding API`\r\n * enabled, otherwise your geocoding requests will be denied.\r\n */\r\nexport function setGoogleApiKey(apiKey: string) {\r\n  googleApiKey = apiKey;\r\n}\r\n\r\nexport async function googleGeocodeAsync(address: string): Promise<LocationGeocodedLocation[]> {\r\n  assertGoogleApiKey();\r\n\r\n  const result = await requestGoogleApiAsync({ address });\r\n\r\n  if (result.status === 'ZERO_RESULTS') {\r\n    return [];\r\n  }\r\n  assertGeocodeResults(result);\r\n  return result.results.map(geocodingResultToLocation);\r\n}\r\n\r\nexport async function googleReverseGeocodeAsync(options: {\r\n  latitude: number;\r\n  longitude: number;\r\n}): Promise<LocationGeocodedAddress[]> {\r\n  assertGoogleApiKey();\r\n\r\n  const result = await requestGoogleApiAsync({\r\n    latlng: `${options.latitude},${options.longitude}`,\r\n  });\r\n\r\n  if (result.status === 'ZERO_RESULTS') {\r\n    return [];\r\n  }\r\n  assertGeocodeResults(result);\r\n  return result.results.map(reverseGeocodingResultToAddress);\r\n}\r\n\r\n// https://developers.google.com/maps/documentation/geocoding/intro\r\nfunction assertGeocodeResults(resultObject: any): void {\r\n  const { status, error_message } = resultObject;\r\n  if (status !== 'ZERO_RESULTS' && status !== 'OK') {\r\n    if (error_message) {\r\n      throw new CodedError(status, error_message);\r\n    } else if (status === 'UNKNOWN_ERROR') {\r\n      throw new CodedError(\r\n        status,\r\n        'the request could not be processed due to a server error. The request may succeed if you try again.'\r\n      );\r\n    }\r\n    throw new CodedError(status, `An error occurred during geocoding.`);\r\n  }\r\n}\r\n\r\n/**\r\n * Makes sure the Google API key is set.\r\n */\r\nfunction assertGoogleApiKey() {\r\n  if (!googleApiKey) {\r\n    throw new Error(\r\n      'Google API key is required to use geocoding. Please set it using `setGoogleApiKey` method.'\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Generic and handy method for sending requests to Google Maps API endpoint.\r\n */\r\nasync function requestGoogleApiAsync(\r\n  params: { address: string } | { latlng: string }\r\n): Promise<GoogleApiGeocodingResponse> {\r\n  const query = Object.entries(params)\r\n    .map((entry) => `${entry[0]}=${encodeURI(entry[1])}`)\r\n    .join('&');\r\n  const result = await fetch(`${GOOGLE_API_URL}?key=${googleApiKey}&${query}`);\r\n  return await result.json();\r\n}\r\n\r\n/**\r\n * Converts Google's result to the location object.\r\n */\r\nfunction geocodingResultToLocation(result: GoogleApiGeocodingResult): LocationGeocodedLocation {\r\n  const { location } = result.geometry;\r\n  return {\r\n    latitude: location.lat,\r\n    longitude: location.lng,\r\n  };\r\n}\r\n\r\n/**\r\n * Converts Google's result to address object.\r\n */\r\nfunction reverseGeocodingResultToAddress(\r\n  result: GoogleApiGeocodingResult\r\n): LocationGeocodedAddress {\r\n  const address: Partial<LocationGeocodedAddress> = {};\r\n\r\n  for (const { long_name, short_name, types } of result.address_components) {\r\n    if (types.includes('locality')) {\r\n      address.city = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('sublocality')) {\r\n      address.district = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('street_number')) {\r\n      address.streetNumber = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('street_address') || types.includes('route')) {\r\n      address.street = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('administrative_area_level_1')) {\r\n      address.region = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('administrative_area_level_2')) {\r\n      address.subregion = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('country')) {\r\n      address.country = long_name;\r\n      address.isoCountryCode = short_name;\r\n      continue;\r\n    }\r\n    if (types.includes('postal_code')) {\r\n      address.postalCode = long_name;\r\n      continue;\r\n    }\r\n    if (types.includes('point_of_interest')) {\r\n      address.name = long_name;\r\n      continue;\r\n    }\r\n  }\r\n  if (!address.name) {\r\n    address.name = result.formatted_address.replace(/,.*$/, '');\r\n  }\r\n  return address as LocationGeocodedAddress;\r\n}\r\n"]}